name: Deploy Admin v2 to Singapore

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Deploy Frontend
  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend

    steps:
      - name: Deploy Frontend to Singapore Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 18.143.118.157
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Deploying Frontend ==="
            cd /home/ubuntu/greenride-admin-v.2
            git pull origin main
            docker stop greenride-admin-v2 || true
            docker rm greenride-admin-v2 || true
            docker build -t greenride-admin-v2 .
            docker run -d --name greenride-admin-v2 -p 3601:3000 --restart unless-stopped greenride-admin-v2
            docker image prune -f
            echo "Frontend deployment complete at $(date)"

  # Job 2: Deploy Backend API
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend API

    steps:
      - name: Deploy Backend to Singapore Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 18.143.118.157
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "=== Deploying Backend API ==="
            REPO_DIR="/home/ubuntu/greenride-admin-v.2"
            BACKEND_DIR="/home/ubuntu/greenride-api"
            BACKEND_CONTAINER="greenride-api"
            
            cd $REPO_DIR
            git pull origin main
            
            mkdir -p $BACKEND_DIR/internal $BACKEND_DIR/logs
            cp -r backend/greenride-api-clean/internal/locales $BACKEND_DIR/internal/ 2>/dev/null || (mkdir -p $BACKEND_DIR/internal/locales && cp -r backend/greenride-api-clean/internal/locales/* $BACKEND_DIR/internal/locales/)
            cp backend/greenride-api-clean/config.yaml $BACKEND_DIR/ 2>/dev/null || true
            if [ -d "$BACKEND_DIR/prod.yaml" ]; then rm -rf "$BACKEND_DIR/prod.yaml"; fi
            if [ ! -f "$BACKEND_DIR/prod.yaml" ]; then cp backend/greenride-api-clean/prod.yaml "$BACKEND_DIR/"; fi
            
            docker build -t $BACKEND_CONTAINER -f backend/greenride-api-clean/Dockerfile backend/greenride-api-clean
            
            docker stop $BACKEND_CONTAINER 2>/dev/null || true
            docker rm $BACKEND_CONTAINER 2>/dev/null || true
            
            NETWORK_FLAG=""
            if docker network inspect greenride-network &>/dev/null; then NETWORK_FLAG="--network greenride-network"; fi
            
            docker run -d --name $BACKEND_CONTAINER --restart unless-stopped $NETWORK_FLAG \
              -p 8610:8610 -p 8611:8611 -p 8612:8612 \
              -v $BACKEND_DIR/config.yaml:/app/config.yaml \
              -v $BACKEND_DIR/prod.yaml:/app/prod.yaml \
              -v $BACKEND_DIR/logs:/app/logs \
              $BACKEND_CONTAINER
            
            echo "Backend deployment complete at $(date)"
            sleep 5
            curl -s -o /dev/null -w "%{http_code}" http://localhost:8611/health || echo "Health check pending..."
